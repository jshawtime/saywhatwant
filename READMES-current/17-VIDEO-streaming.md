{"name": "cloudflare\_r2\_cdn", "type": "document", "content": "# README: DIY Video Hosting on Cloudflare R2 + CDN (Progressive MP4)\n\nThis document describes how to serve short-form video clips (e.g., 9:16, 720p, \~8s, \~4MB each) using Cloudflare R2 object storage and Cloudflare CDN (Workers/Pages/Cache). The goal is ultra-low cost delivery (\~\$0.36 per 1M plays + storage), without managed transcoding, HLS/DASH packaging, or DRM.\n\n---\n\n## 1. Architecture Overview\n- **Storage**: Cloudflare R2 (S3-compatible object storage). Zero egress fees.\n- **Delivery**: Cloudflare CDN (global edge caching, Cache Reserve optional).\n- **Format**: Progressive MP4 (single file per clip). Encoded at fixed resolution/bitrate (e.g., 720p \~0.6–1 Mbps).\n- **Access control**: (optional) Signed URLs via Cloudflare Workers.\n- **Playback**: Native HTML5 `<video>` or JS player (no adaptive bitrate needed).\n\n`\nUser → Cloudflare CDN Edge → (Cache Reserve optional) → R2 Bucket → MP4 file\n`\n\n---\n\n## 2. Cost Model\n- **Storage**: \$0.015/GB-month (as of 2025). Example: 10k clips × 4MB = 40GB ≈ \$0.60/month.\n- **Requests**: \$0.36 per 1M GET requests.\n- **Egress**: \$0 (R2 → CDN → client).\n\n### Example Calculation (1M plays, 4MB per file)\n- GET requests: 1M × \$0.36 ≈ \$0.36.\n- Data transfer: 4 TB/month → \$0 (egress free).\n- Storage: 40GB ≈ \$0.60.\n- **Total ≈ \$1.00/month for 1M plays.**\n\n---\n\n## 3. Bucket Setup\n1. Create an R2 bucket in Cloudflare dashboard.\n2. Enable **public access** (if all clips public) OR configure signed URLs via Workers.\n3. Upload MP4 files via S3 API:\n   `bash\n   aws s3 cp video.mp4 s3://your-bucket/video.mp4 \\\n       --endpoint-url=https://<accountid>.r2.cloudflarestorage.com\n   `\n\n---\n\n## 4. File Format (Encoding Guidelines)\n- **Container**: MP4 (MPEG-4 Part 14).\n- **Video codec**: H.264 baseline/high profile.\n- **Audio codec**: omit or include silent AAC track (some browsers expect audio).\n- **Bitrate target**: \~600–800 kbps (≈0.6–0.8 MB per 8s clip).\n- **Frame rate**: 24–30 fps.\n\n`ffmpeg` example:\n`bash\nffmpeg -i input.mov -c:v libx264 -preset fast -profile:v main -pix_fmt yuv420p \\\n  -b:v 700k -maxrate 800k -bufsize 1400k -an \\\n  -movflags +faststart output.mp4\n`\n\n---\n\n## 5. CDN Integration\n- Add a **Cloudflare DNS route** (e.g., `videos.example.com`) pointing to the R2 bucket via **R2 custom domain binding**.\n- Enable **Cache Reserve** to reduce origin hits (useful for viral clips).\n- Set Cache-Control headers for long TTLs:\n  `http\n  Cache-Control: public, max-age=31536000, immutable\n  `\n\n---\n\n## 6. Playback\n### HTML5 Video\n`html\n<video autoplay loop muted playsinline>\n  <source src=\"https://videos.example.com/clip123.mp4\" type=\"video/mp4\">\n</video>\n`\n\n### JS Player (optional)\n- Any player that supports progressive MP4.\n- No adaptive streaming required; each clip is short.\n\n---\n\n## 7. Optional Enhancements\n- **Signed URLs** (via Cloudflare Workers):\n  - Use JWT or HMAC signature.\n  - Worker validates before proxying to R2.\n- **Compression / Preprocessing**:\n  - Run offline ffmpeg pipeline to crush files before upload.\n  - Deduplicate similar clips to save storage.\n- **Analytics**:\n  - Use Cloudflare Logs / Workers KV to count plays.\n  - Or instrument JS playback events client-side.\n\n---\n\n## 8. Limitations\n- No adaptive bitrate (one quality per clip).\n- No DRM (only simple signed URLs).\n- Must manage transcoding pipeline yourself.\n- Users on slow connections may stall (progressive MP4 cannot adapt mid-play).\n\n---\n\n## 9. Future Scale Considerations\n- If storage/processing pipeline grows, use **R2 + Cloudflare Images/Stream** hybrid (Stream for long-form, R2 for short eye-candy).\n- If you need DRM, consider migrating to Mux or Bunny Stream.\n\n---\n\n## 10. Key Takeaway\nFor ultra-short, low-value video clips, **R2 + CDN + progressive MP4** is the cheapest at scale. You pay essentially **for requests only** (\~\$0.36 per million plays), with storage being negligible."}
