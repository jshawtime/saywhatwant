<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic URL Enhancement Test Suite</title>
    <style>
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #60a5fa; margin-bottom: 30px; }
        h2 { color: #34d399; margin-top: 40px; }
        .test-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-url {
            background: #0f172a;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
            font-family: 'SF Mono', monospace;
            font-size: 14px;
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
            font-size: 14px;
            transition: all 0.2s;
        }
        .test-button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        .copy-button {
            background: #10b981;
        }
        .copy-button:hover {
            background: #059669;
        }
        .description {
            color: #9ca3af;
            margin: 10px 0;
        }
        .expected {
            background: #064e3b;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 10px;
            font-weight: 600;
        }
        .status.success { background: #10b981; }
        .status.info { background: #3b82f6; }
    </style>
</head>
<body>
    <h1>üß™ Dynamic URL Enhancement Test Suite</h1>
    <p class="description">Test all new URL parameters and their combinations</p>

    <h2>1Ô∏è‚É£ Filter Bar Control</h2>
    
    <div class="test-card">
        <h3>Filter Active = True</h3>
        <div class="test-url">#filteractive=true</div>
        <p class="description">Forces filter bar ON (LED lit) even on base URL</p>
        <button class="test-button" onclick="testURL('#filteractive=true')">Test This URL</button>
        <button class="test-button copy-button" onclick="copyURL('#filteractive=true')">Copy URL</button>
        <div class="expected">‚úÖ Expected: Filter bar LED should be lit</div>
    </div>

    <div class="test-card">
        <h3>Filter Active = False with Filters</h3>
        <div class="test-url">#filteractive=false&u=alice:255000000</div>
        <p class="description">Filter bar has alice filter but LED is OFF</p>
        <button class="test-button" onclick="testURL('#filteractive=false&u=alice:255000000')">Test This URL</button>
        <button class="test-button copy-button" onclick="copyURL('#filteractive=false&u=alice:255000000')">Copy URL</button>
        <div class="expected">‚úÖ Expected: Filter bar shows alice but LED is dimmed</div>
    </div>

    <h2>2Ô∏è‚É£ Model Conversations</h2>
    
    <div class="test-card">
        <h3>Single Model</h3>
        <div class="test-url">#model=highermind_the-eternal-1</div>
        <p class="description">Triggers TheEternal AI to greet and respond</p>
        <button class="test-button" onclick="testURL('#model=highermind_the-eternal-1')">Test This URL</button>
        <button class="test-button copy-button" onclick="copyURL('#model=highermind_the-eternal-1')">Copy URL</button>
        <div class="expected">‚úÖ Expected: TheEternal greeting appears, domain changes</div>
    </div>

    <div class="test-card">
        <h3>Model with Random Color</h3>
        <div class="test-url">#model=highermind_the-eternal-1:random</div>
        <p class="description">Model gets random color, URL updates with actual color</p>
        <button class="test-button" onclick="testURL('#model=highermind_the-eternal-1:random')">Test This URL</button>
        <button class="test-button copy-button" onclick="copyURL('#model=highermind_the-eternal-1:random')">Copy URL</button>
        <div class="expected">‚úÖ Expected: Random color generated, URL shows RGB values</div>
    </div>

    <div class="test-card">
        <h3>Multiple Models</h3>
        <div class="test-url">#model=highermind_the-eternal-1+fear_and_loathing</div>
        <p class="description">Both models respond in sequence</p>
        <button class="test-button" onclick="testURL('#model=highermind_the-eternal-1+fear_and_loathing')">Test This URL</button>
        <button class="test-button copy-button" onclick="copyURL('#model=highermind_the-eternal-1+fear_and_loathing')">Copy URL</button>
        <div class="expected">‚úÖ Expected: TheEternal greets, then FearAndLoathing greets</div>
    </div>

    <div class="test-card">
        <h3>Model by Entity ID</h3>
        <div class="test-url">#model=eternal-tech</div>
        <p class="description">Uses entity ID instead of model name</p>
        <button class="test-button" onclick="testURL('#model=eternal-tech')">Test This URL</button>
        <button class="test-button copy-button" onclick="copyURL('#model=eternal-tech')">Copy URL</button>
        <div class="expected">‚úÖ Expected: TechEternal personality loads</div>
    </div>

    <h2>3Ô∏è‚É£ User State</h2>
    
    <div class="test-card">
        <h3>Human Username & Color</h3>
        <div class="test-url">#uis=Alice:255000000</div>
        <p class="description">Sets human user as Alice with red color</p>
        <button class="test-button" onclick="testURL('#uis=Alice:255000000')">Test This URL</button>
        <button class="test-button copy-button" onclick="copyURL('#uis=Alice:255000000')">Copy URL</button>
        <div class="expected">‚úÖ Expected: Username input shows "Alice", color is red</div>
    </div>

    <div class="test-card">
        <h3>Random Human Color</h3>
        <div class="test-url">#uis=Bob:random</div>
        <p class="description">Bob gets random color, URL updates</p>
        <button class="test-button" onclick="testURL('#uis=Bob:random')">Test This URL</button>
        <button class="test-button copy-button" onclick="copyURL('#uis=Bob:random')">Copy URL</button>
        <div class="expected">‚úÖ Expected: Bob with random color, URL shows actual RGB</div>
    </div>

    <div class="test-card">
        <h3>AI Username & Color</h3>
        <div class="test-url">#ais=Assistant:000255000</div>
        <p class="description">Sets AI display name and color</p>
        <button class="test-button" onclick="testURL('#ais=Assistant:000255000')">Test This URL</button>
        <button class="test-button copy-button" onclick="copyURL('#ais=Assistant:000255000')">Copy URL</button>
        <div class="expected">‚úÖ Expected: AI appears as "Assistant" with green color</div>
    </div>

    <h2>4Ô∏è‚É£ Complete Scenarios</h2>
    
    <div class="test-card">
        <h3>Private AI Conversation</h3>
        <div class="test-url">#filteractive=true&model=highermind_the-eternal-1:random&uis=Alice:random</div>
        <p class="description">Complete private conversation setup with random colors</p>
        <button class="test-button" onclick="testURL('#filteractive=true&model=highermind_the-eternal-1:random&uis=Alice:random')">Test This URL</button>
        <button class="test-button copy-button" onclick="copyURL('#filteractive=true&model=highermind_the-eternal-1:random&uis=Alice:random')">Copy URL</button>
        <div class="expected">
            ‚úÖ Expected:<br>
            - Filter bar ON<br>
            - Alice with random color<br>
            - TheEternal greets with random color<br>
            - Domain changes to model name<br>
            - Only Alice/TheEternal messages in context
        </div>
    </div>

    <div class="test-card">
        <h3>Multi-Model Discussion</h3>
        <div class="test-url">#filteractive=true&model=eternal-main+fear-main&uis=Human:138043226</div>
        <p class="description">Two AI personalities in conversation</p>
        <button class="test-button" onclick="testURL('#filteractive=true&model=eternal-main+fear-main&uis=Human:138043226')">Test This URL</button>
        <button class="test-button copy-button" onclick="copyURL('#filteractive=true&model=eternal-main+fear-main&uis=Human:138043226')">Copy URL</button>
        <div class="expected">
            ‚úÖ Expected:<br>
            - Both AIs greet in sequence<br>
            - Human has purple color<br>
            - Filter shows all participants<br>
            - Context isolated to conversation
        </div>
    </div>

    <div class="test-card">
        <h3>Creative Session</h3>
        <div class="test-url">#model=fear-creative&uis=Artist:random&filteractive=true</div>
        <p class="description">Creative AI with artist user</p>
        <button class="test-button" onclick="testURL('#model=fear-creative&uis=Artist:random&filteractive=true')">Test This URL</button>
        <button class="test-button copy-button" onclick="copyURL('#model=fear-creative&uis=Artist:random&filteractive=true')">Copy URL</button>
        <div class="expected">
            ‚úÖ Expected:<br>
            - CreativeFear personality loads<br>
            - "Artist" username with random color<br>
            - Creative greeting message<br>
            - Filter bar active
        </div>
    </div>

    <h2>5Ô∏è‚É£ URL Updates</h2>
    
    <div class="test-card">
        <h3>Random Color Resolution</h3>
        <p class="description">After loading a URL with "random", the URL should update to show actual RGB values</p>
        <div class="test-url">Before: #uis=User:random&model=highermind_the-eternal-1:random</div>
        <div class="test-url">After: #uis=User:123045067&model=highermind_the-eternal-1:234156078</div>
        <div class="expected">‚úÖ URL updates with actual color values for bookmarking</div>
    </div>

    <h2>üóëÔ∏è Storage Management</h2>
    
    <div class="test-card">
        <h3>Clear Local Storage</h3>
        <p class="description">Clear IndexedDB database and localStorage to start fresh</p>
        <button class="test-button" onclick="clearIndexedDB()">Clear IndexedDB</button>
        <button class="test-button" onclick="clearCommentCache()">Clear Comment Cache Only</button>
        <button class="test-button" onclick="checkDatabaseStatus()">Check Database Status</button>
        <button class="test-button" onclick="diagnoseProblem()">üîç Diagnose Storage</button>
        <button class="test-button" onclick="clearAllStorage()">Clear Everything</button>
        <div id="db-status" style="margin-top: 20px; padding: 15px; background: #1f2937; border-radius: 4px; display: none;"></div>
    </div>
    
    <div class="test-card">
        <h3>üÜï Simple IndexedDB Manager (NEW!)</h3>
        <p class="description">Test the new simplified IndexedDB system that stores Comments exactly as KV</p>
        <button class="test-button" onclick="testSimpleDB()" style="background-color: #10b981;">Test Simple DB</button>
        <button class="test-button" onclick="simpleDBDebug()" style="background-color: #3b82f6;">Debug Simple DB</button>
        <button class="test-button" onclick="simpleDBClear()" style="background-color: #ef4444;">Clear Simple DB</button>
        <div id="simpleDbStatus" style="margin-top: 20px; padding: 15px; background: #1f2937; border-radius: 4px; display: none;"></div>
    </div>
    
    <div class="test-card">
        <h3>View KV Storage Status</h3>
        <p class="description">Monitor KV store contents and color formats in real-time</p>
            <button class="test-button" onclick="checkKVStatus()">Check KV Status</button>
            <button class="test-button" onclick="viewRecentMessages()">View Recent Messages (RAW)</button>
            <button class="test-button" onclick="copyAllKVData()">Copy All KV Data</button>
            <button class="test-button" id="auto-refresh-btn" onclick="toggleAutoRefresh()">Enable Auto-Refresh</button>
        <div id="kv-viewer" style="margin-top: 20px; padding: 15px; background: #1f2937; border-radius: 4px; display: none;">
            <div id="kv-content">Loading...</div>
        </div>
    </div>
    
    <div class="test-card">
        <h3>AI Bot Control</h3>
        <p class="description">Manage the AI bot service</p>
        <button class="test-button" onclick="checkBotStatus()">Check Bot Status</button>
        <button class="test-button" onclick="restartBot()">Restart AI Bot</button>
        <button class="test-button" onclick="stopBot()">Stop AI Bot</button>
        <button class="test-button" onclick="startBot()">Start AI Bot</button>
        <div id="bot-status" style="margin-top: 20px; padding: 15px; background: #1f2937; border-radius: 4px; display: none;"></div>
    </div>
    
    <div class="test-card">
        <h3>Clear Cloudflare KV Storage</h3>
        <p class="description">Remove all comments from the server</p>
        <button class="test-button" onclick="showKVClearInstructions()">Show Clear Instructions</button>
        <button class="test-button copy-button" onclick="copyKVClearCommand()">Copy Terminal Command</button>
        <div id="kv-instructions" style="margin-top: 20px; padding: 20px; background: #1f2937; border-radius: 4px; display: none;">
            <h4 style="color: #fbbf24; margin-top: 0;">‚ö° Fast Clear Cloudflare KV Store</h4>
            <p style="color: #e5e7eb; margin: 10px 0;">Run this command in your terminal (takes seconds, not hours!):</p>
            <div style="background: #111827; padding: 12px; border-radius: 4px; font-family: 'Courier New', monospace; margin: 10px 0; border: 1px solid #374151;">
                <code id="kv-command" style="color: #10b981; font-size: 12px;">cd /Users/pbmacstudiomain/devrepo/SAYWHATWANTv1/saywhatwant && node scripts/kv-bulk-clear-final.js</code>
            </div>
            <p style="color: #10b981; font-weight: bold; margin: 10px 0;">‚úÖ Bulk deletes up to 10,000 keys at once - MUCH faster!</p>
            <p style="color: #ef4444; margin: 10px 0;">‚ö†Ô∏è This will permanently delete ALL comments from KV storage</p>
            
            <div style="background: #1e3a5f; padding: 10px; border-radius: 4px; margin: 15px 0; border: 1px solid #3b82f6;">
                <p style="color: #93c5fd; margin: 5px 0; font-weight: bold;">After clearing:</p>
                <ul style="color: #ddd6fe; margin: 5px 0 5px 20px;">
                    <li>New comments use 9-digit format: <code style="color: #10b981;">255020147</code></li>
                    <li>Old RGB format removed: <code style="color: #ef4444;">rgb(255, 20, 147)</code></li>
                    <li>Consistent color format throughout</li>
                </ul>
            </div>
            
            <details style="margin-top: 15px;">
                <summary style="color: #fbbf24; cursor: pointer;">Alternative Methods</summary>
                <div style="margin: 10px 0 0 20px; font-size: 14px;">
                    <p style="color: #94a3b8; margin: 10px 0;">Other scripts available:</p>
                    <ul style="color: #e5e7eb; margin: 10px 0;">
                        <li style="margin: 5px 0;">Slow but interactive: <code style="color: #60a5fa; font-size: 11px;">node scripts/clear-kv.js</code> (requires manual confirmation)</li>
                        <li style="margin: 5px 0;">Auto-confirm slow: <code style="color: #60a5fa; font-size: 11px;">echo "yes" | node scripts/clear-kv.js</code> (takes hours)</li>
                        <li style="margin: 5px 0;">Shell script: <code style="color: #60a5fa; font-size: 11px;">./scripts/fast-kv-clear.sh</code> (requires jq)</li>
                    </ul>
                    <p style="color: #ef4444; margin-top: 10px;">Note: Namespace cannot be deleted while bound to workers</p>
                </div>
            </details>
        </div>
        <div class="expected">‚úÖ Use this to clear KV and start fresh with 9-digit colors</div>
    </div>

    <script>
        // Global variable for auto-refresh
        let autoRefreshInterval = null;
        
        // Test function - opens URL in new tab
        function testURL(hash) {
            // Use the live site URL
            const baseUrl = 'https://saywhatwant.app';
            const testUrl = baseUrl + '/' + hash;
            window.open(testUrl, '_blank');
            
            // Show status
            showStatus('Opened in new tab: ' + testUrl);
        }
        
        // Copy URL to clipboard
        function copyURL(hash) {
            // Use the live site URL
            const baseUrl = 'https://saywhatwant.app';
            const fullUrl = baseUrl + '/' + hash;
            
            navigator.clipboard.writeText(fullUrl).then(() => {
                showStatus('Copied to clipboard: ' + fullUrl, 'success');
            }).catch(err => {
                showStatus('Failed to copy URL', 'error');
            });
        }
        
        // Clean up auto-refresh on page unload
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
        
        // AI Bot Control Functions
        function checkBotStatus() {
            const statusDiv = document.getElementById('bot-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                <h4 style="color: #10b981;">ü§ñ AI Bot Status Check</h4>
                <p style="color: #e5e7eb;">Run this command to check if the bot is running:</p>
                <div style="background: #111827; padding: 10px; border-radius: 4px; margin: 10px 0;">
                    <code style="color: #60a5fa; font-size: 12px;">ps aux | grep -E "(tsx.*index\\.ts|node.*dist/index\\.js)" | grep -v grep</code>
                </div>
                <button onclick="copyCommand('ps aux | grep -E \\"(tsx.*index\\\\.ts|node.*dist/index\\\\.js)\\" | grep -v grep')" 
                        style="padding: 4px 12px; background: #374151; color: #60a5fa; border: 1px solid #4b5563; border-radius: 4px; cursor: pointer;">
                    Copy Command
                </button>
            `;
            showStatus('Check terminal for bot processes', 'info');
        }
        
        function restartBot() {
            const statusDiv = document.getElementById('bot-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                <h4 style="color: #fbbf24;">üîÑ Restart AI Bot</h4>
                <p style="color: #e5e7eb;">Run these commands to restart the bot with new configs:</p>
                <div style="background: #111827; padding: 10px; border-radius: 4px; margin: 10px 0;">
                    <code style="color: #10b981; font-size: 12px;">
                        # 1. Find and stop current bot<br>
                        pkill -f "node.*dist/index.js" || pkill -f "tsx.*src/index.ts"<br><br>
                        # 2. Navigate to AI bot directory<br>
                        cd /Users/pbmacstudiomain/devrepo/SAYWHATWANTv1/saywhatwant/ai<br><br>
                        # 3. Rebuild and start<br>
                        npm run build && npm start
                    </code>
                </div>
                <button onclick="copyRestartCommands()" 
                        style="padding: 4px 12px; background: #374151; color: #10b981; border: 1px solid #4b5563; border-radius: 4px; cursor: pointer;">
                    Copy All Commands
                </button>
                <p style="color: #94a3b8; font-size: 12px; margin-top: 10px;">
                    üí° This will reload configs and ensure 9-digit colors are used
                </p>
            `;
            showStatus('Restart commands ready - copy and run in terminal', 'success');
        }
        
        function stopBot() {
            const statusDiv = document.getElementById('bot-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                <h4 style="color: #ef4444;">‚èπÔ∏è Stop AI Bot</h4>
                <p style="color: #e5e7eb;">Run this command to stop the bot:</p>
                <div style="background: #111827; padding: 10px; border-radius: 4px; margin: 10px 0;">
                    <code style="color: #ef4444; font-size: 12px;">pkill -f "node.*dist/index.js" || pkill -f "tsx.*src/index.ts"</code>
                </div>
                <button onclick="copyCommand('pkill -f \\"node.*dist/index.js\\" || pkill -f \\"tsx.*src/index.ts\\"')" 
                        style="padding: 4px 12px; background: #374151; color: #ef4444; border: 1px solid #4b5563; border-radius: 4px; cursor: pointer;">
                    Copy Command
                </button>
            `;
            showStatus('Stop command ready', 'info');
        }
        
        function startBot() {
            const statusDiv = document.getElementById('bot-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                <h4 style="color: #10b981;">‚ñ∂Ô∏è Start AI Bot</h4>
                <p style="color: #e5e7eb;">Choose your start mode:</p>
                
                <div style="margin-top: 15px;">
                    <h5 style="color: #60a5fa;">Production Mode (Background):</h5>
                    <div style="background: #111827; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <code style="color: #10b981; font-size: 12px;">
                            cd /Users/pbmacstudiomain/devrepo/SAYWHATWANTv1/saywhatwant/ai<br>
                            npm start &
                        </code>
                    </div>
                    <button onclick="copyCommand('cd /Users/pbmacstudiomain/devrepo/SAYWHATWANTv1/saywhatwant/ai && npm start &')" 
                            style="padding: 4px 12px; background: #374151; color: #10b981; border: 1px solid #4b5563; border-radius: 4px; cursor: pointer;">
                        Copy Production Command
                    </button>
                </div>
                
                <div style="margin-top: 15px;">
                    <h5 style="color: #a78bfa;">Development Mode (Live Reload):</h5>
                    <div style="background: #111827; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <code style="color: #a78bfa; font-size: 12px;">
                            cd /Users/pbmacstudiomain/devrepo/SAYWHATWANTv1/saywhatwant/ai<br>
                            npm run dev
                        </code>
                    </div>
                    <button onclick="copyCommand('cd /Users/pbmacstudiomain/devrepo/SAYWHATWANTv1/saywhatwant/ai && npm run dev')" 
                            style="padding: 4px 12px; background: #374151; color: #a78bfa; border: 1px solid #4b5563; border-radius: 4px; cursor: pointer;">
                        Copy Dev Command
                    </button>
                </div>
            `;
            showStatus('Start commands ready - choose your mode', 'info');
        }
        
        function copyCommand(command) {
            navigator.clipboard.writeText(command).then(() => {
                showStatus('‚úÖ Command copied to clipboard', 'success');
            }).catch(err => {
                showStatus('‚ùå Failed to copy: ' + err, 'error');
            });
        }
        
        function copyRestartCommands() {
            const commands = `pkill -f "node.*dist/index.js" || pkill -f "tsx.*src/index.ts"
cd /Users/pbmacstudiomain/devrepo/SAYWHATWANTv1/saywhatwant/ai
npm run build && npm start`;
            
            navigator.clipboard.writeText(commands).then(() => {
                showStatus('‚úÖ All restart commands copied to clipboard', 'success');
            }).catch(err => {
                showStatus('‚ùå Failed to copy: ' + err, 'error');
            });
        }
        
        // Show status message
        function showStatus(message, type = 'info') {
            // Remove existing status
            const existing = document.querySelector('.status-message');
            if (existing) existing.remove();
            
            // Create new status
            const status = document.createElement('div');
            status.className = 'status ' + type;
            status.textContent = message;
            status.style.position = 'fixed';
            status.style.bottom = '20px';
            status.style.right = '20px';
            status.style.zIndex = '9999';
            document.body.appendChild(status);
            
            // Auto remove after 3 seconds
            setTimeout(() => status.remove(), 3000);
        }
        
        // Display current URL parameters on load
        window.addEventListener('load', () => {
            if (window.location.hash) {
                showStatus('Current URL: ' + window.location.hash);
            }
        });
        
        // SimpleIndexedDB Testing Functions (NEW!)
        async function testSimpleDB() {
            const statusDiv = document.getElementById('simpleDbStatus');
            if (!statusDiv) return;
            statusDiv.style.display = 'block';
            
            try {
                // Dynamic import of SimpleIndexedDB
                const module = await import('/modules/storage/simple-indexeddb.js');
                const { simpleIndexedDB } = module;
                
                // Initialize
                await simpleIndexedDB.init();
                
                // Test saving a message
                const testMessage = {
                    id: `test-${Date.now()}`,
                    text: 'Test message from test-url-integration',
                    timestamp: Date.now(),
                    username: 'TestUser',
                    color: '255000000',
                    domain: 'saywhatwant.app',
                    language: 'en',
                    'message-type': 'human',
                    misc: ''
                };
                
                await simpleIndexedDB.saveMessage(testMessage);
                
                // Get count
                const count = await simpleIndexedDB.getMessageCount();
                
                // Get latest messages
                const messages = await simpleIndexedDB.getMessages(5, 0);
                
                statusDiv.innerHTML = `<div style="color: #10b981;">‚úÖ SimpleIndexedDB Working!</div>
<div style="color: #fbbf24;">Message Count: ${count}</div>
<div style="color: #60a5fa;">Latest 5 messages:</div>
${messages.map(m => `<div style="color: #d1d5db; padding-left: 10px;">‚Ä¢ ${m.username}: ${m.text.substring(0, 50)}...</div>`).join('')}`;
            } catch (error) {
                statusDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function simpleDBDebug() {
            const statusDiv = document.getElementById('simpleDbStatus');
            if (!statusDiv) return;
            statusDiv.style.display = 'block';
            
            try {
                const module = await import('/modules/storage/simple-indexeddb.js');
                const { simpleIndexedDB } = module;
                
                await simpleIndexedDB.debug();
                statusDiv.innerHTML = '<div style="color: #10b981;">‚úÖ Debug info logged to console</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function simpleDBClear() {
            const statusDiv = document.getElementById('simpleDbStatus');
            if (!statusDiv) return;
            statusDiv.style.display = 'block';
            
            if (!confirm('Clear all messages from SimpleIndexedDB?')) return;
            
            try {
                const module = await import('/modules/storage/simple-indexeddb.js');
                const { simpleIndexedDB } = module;
                
                await simpleIndexedDB.clear();
                statusDiv.innerHTML = '<div style="color: #10b981;">‚úÖ SimpleIndexedDB cleared</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Legacy IndexedDB Management Functions
        async function diagnoseProblem() {
            const statusDiv = document.getElementById('db-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div style="color: #60a5fa;">üîç Diagnosing storage issue...</div>';
            
            let html = '<h3 style="color: #fbbf24;">Storage Diagnosis Report</h3>';
            
            // Check ALL localStorage keys
            html += '<h4 style="color: #34d399; margin-top: 15px;">LocalStorage Keys:</h4>';
            const suspectKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('comment') || key.includes('message') || key.includes('sww'))) {
                    const value = localStorage.getItem(key);
                    let info = 'unknown';
                    try {
                        const parsed = JSON.parse(value);
                        if (Array.isArray(parsed)) {
                            info = `${parsed.length} items`;
                            if (parsed.length > 0) suspectKeys.push(key);
                        } else {
                            info = typeof parsed;
                        }
                    } catch (e) {
                        info = `${value?.length || 0} chars`;
                    }
                    const color = key.includes('comment') || key.includes('message') ? '#ef4444' : '#60a5fa';
                    html += `<div style="color: ${color};">‚Ä¢ ${key}: ${info}</div>`;
                }
            }
            
            // Check IndexedDB
            html += '<h4 style="color: #34d399; margin-top: 15px;">IndexedDB Status:</h4>';
            try {
                const databases = await indexedDB.databases();
                if (databases.length > 0) {
                    for (const db of databases) {
                        if (db.name === 'SayWhatWant') {
                            html += `<div style="color: #ef4444;">‚ö†Ô∏è Database exists: ${db.name} (version ${db.version})</div>`;
                            
                            // Try to open and check content
                            try {
                                const openReq = indexedDB.open(db.name);
                                const database = await new Promise((resolve, reject) => {
                                    openReq.onsuccess = () => resolve(openReq.result);
                                    openReq.onerror = reject;
                                });
                                
                                let totalMessages = 0;
                                if (database.objectStoreNames.contains('messages_temp')) {
                                    const tx = database.transaction(['messages_temp'], 'readonly');
                                    const store = tx.objectStore('messages_temp');
                                    const countReq = store.count();
                                    const tempCount = await new Promise((resolve) => {
                                        countReq.onsuccess = () => resolve(countReq.result);
                                    });
                                    totalMessages += tempCount;
                                    html += `<div style="color: #fbbf24;">  ‚Üí messages_temp: ${tempCount} messages</div>`;
                                }
                                
                                if (database.objectStoreNames.contains('messages_perm')) {
                                    const tx = database.transaction(['messages_perm'], 'readonly');
                                    const store = tx.objectStore('messages_perm');
                                    const countReq = store.count();
                                    const permCount = await new Promise((resolve) => {
                                        countReq.onsuccess = () => resolve(countReq.result);
                                    });
                                    totalMessages += permCount;
                                    html += `<div style="color: #fbbf24;">  ‚Üí messages_perm: ${permCount} messages</div>`;
                                }
                                
                                html += `<div style="color: #ef4444; font-weight: bold;">  üìä TOTAL MESSAGES: ${totalMessages}</div>`;
                                
                                database.close();
                            } catch (e) {
                                html += '<div style="color: #6b7280;">  ‚Üí Could not open database</div>';
                            }
                        }
                    }
                } else {
                    html += '<div style="color: #10b981;">‚úÖ No IndexedDB databases found</div>';
                }
            } catch (e) {
                html += '<div style="color: #6b7280;">Could not enumerate databases</div>';
            }
            
            // Check KV status
            html += '<h4 style="color: #34d399; margin-top: 15px;">KV Store Status:</h4>';
            try {
                const response = await fetch('https://sww-comments.bootloaders.workers.dev/api/comments?limit=1');
                const data = await response.json();
                if (data.comments && data.comments.length > 0) {
                    html += `<div style="color: #ef4444;">‚ö†Ô∏è KV has ${data.total || 'some'} messages!</div>`;
                } else {
                    html += '<div style="color: #10b981;">‚úÖ KV is empty</div>';
                }
            } catch (e) {
                html += '<div style="color: #6b7280;">Could not check KV</div>';
            }
            
            // Recommendation
            html += '<h4 style="color: #fbbf24; margin-top: 20px;">Recommendation:</h4>';
            if (suspectKeys.length > 0) {
                html += '<div style="color: #ef4444; font-weight: bold;">‚ö†Ô∏è Found suspect localStorage keys with data!</div>';
                html += '<div style="color: #e5e7eb;">Click "Clear Everything" and restart Chrome completely.</div>';
                html += '<div style="color: #e5e7eb; margin-top: 5px;">Then check this diagnosis again before visiting the app.</div>';
            } else {
                html += '<div style="color: #10b981;">Storage appears clean. If you still see messages, they may be:</div>';
                html += '<div style="color: #e5e7eb; margin-left: 20px;">‚Ä¢ Coming from browser cache (try Incognito mode)</div>';
                html += '<div style="color: #e5e7eb; margin-left: 20px;">‚Ä¢ Service worker cache (check DevTools ‚Üí Application)</div>';
                html += '<div style="color: #e5e7eb; margin-left: 20px;">‚Ä¢ CDN cache (wait or use cache-bust params)</div>';
            }
            
            statusDiv.innerHTML = html;
        }
        
        function clearCommentCache() {
            const statusDiv = document.getElementById('db-status');
            statusDiv.style.display = 'block';
            
            // List of ALL possible comment storage keys
            const commentKeys = [
                'sww-comments',           // Main app storage
                'sww-comments-local',      // IndexedDB adapter key
                'COMMENTS_STORAGE_KEY',    // Just in case
                'sww-comments-backup',     // Possible backup
                'sww-messages'             // Alternative naming
            ];
            
            let totalRemoved = 0;
            let details = [];
            
            commentKeys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        const count = Array.isArray(parsed) ? parsed.length : 1;
                        totalRemoved += count;
                        details.push(`${key}: ${count} messages`);
                        localStorage.removeItem(key);
                    } catch (e) {
                        localStorage.removeItem(key);
                        details.push(`${key}: removed (invalid JSON)`);
                    }
                }
            });
            
            // Also check for any keys containing 'comment' or 'message'
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('comment') || key.includes('message')) && !commentKeys.includes(key)) {
                    details.push(`Found and removing: ${key}`);
                    localStorage.removeItem(key);
                }
            }
            
            if (totalRemoved > 0 || details.length > 0) {
                let html = `<div style="color: #10b981;">‚úÖ Cleared ${totalRemoved} cached comments!</div>`;
                if (details.length > 0) {
                    html += '<div style="margin-top: 10px; font-size: 12px; color: #94a3b8;">';
                    details.forEach(d => {
                        html += `<div>‚Ä¢ ${d}</div>`;
                    });
                    html += '</div>';
                }
                statusDiv.innerHTML = html;
                showStatus(`Removed ${totalRemoved} cached comments`, 'success');
            } else {
                statusDiv.innerHTML = '<div style="color: #60a5fa;">‚ÑπÔ∏è No cached comments found in any localStorage keys</div>';
                showStatus('No comment cache to clear', 'info');
            }
        }
        
        async function clearIndexedDB() {
            const statusDiv = document.getElementById('db-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div style="color: #60a5fa;">üîÑ Clearing IndexedDB...</div>';
            
            try {
                // CRITICAL: Clear ALL comment-related storage FIRST!
                const commentKeys = [
                    'sww-comments',
                    'sww-comments-local',
                    'COMMENTS_STORAGE_KEY'
                ];
                
                commentKeys.forEach(key => {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const count = JSON.parse(data).length || 0;
                            console.log(`Removing ${key}: ${count} messages`);
                        } catch (e) {
                            console.log(`Removing ${key}: invalid data`);
                        }
                        localStorage.removeItem(key);
                    }
                });
                
                // Clear other localStorage items that might affect the app
                localStorage.removeItem('sww-indexeddb-initialized');
                localStorage.removeItem('sww-indexeddb-messages-count');
                // Removed: sww-filter-enabled - URL is now the single source of truth
                localStorage.removeItem('sww-filters');
                localStorage.removeItem('sww-word-filters');
                localStorage.removeItem('sww-negative-filters');
                
                // Delete the database
                const deleteReq = indexedDB.deleteDatabase('SayWhatWant');
                
                await new Promise((resolve, reject) => {
                    deleteReq.onsuccess = resolve;
                    deleteReq.onerror = reject;
                    deleteReq.onblocked = () => {
                        statusDiv.innerHTML = '<div style="color: #f59e0b;">‚ö†Ô∏è Database is blocked. Please close all Say What Want tabs and try again.</div>';
                    };
                });
                
                statusDiv.innerHTML = '<div style="color: #10b981;">‚úÖ IndexedDB cleared successfully!</div>';
                showStatus('IndexedDB cleared!', 'success');
            } catch (error) {
                statusDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
                showStatus('Failed to clear IndexedDB', 'error');
            }
        }
        
        async function checkDatabaseStatus() {
            const statusDiv = document.getElementById('db-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div style="color: #60a5fa;">üîç Checking database...</div>';
            
            try {
                const openReq = indexedDB.open('SayWhatWant', 1);
                
                const db = await new Promise((resolve, reject) => {
                    openReq.onsuccess = () => resolve(openReq.result);
                    openReq.onerror = reject;
                    openReq.onupgradeneeded = () => {
                        statusDiv.innerHTML = '<div style="color: #10b981;">‚ú® Database is empty (will be created on first use)</div>';
                        reject(new Error('Database not initialized'));
                    };
                });
                
                const storeNames = ['messages_temp', 'messages_perm', 'lifetime_filters', 'filter_stats'];
                let html = '<h3 style="color: #34d399;">Database Status:</h3>';
                let totalMessages = 0;
                
                for (const storeName of storeNames) {
                    if (db.objectStoreNames.contains(storeName)) {
                        const transaction = db.transaction([storeName], 'readonly');
                        const store = transaction.objectStore(storeName);
                        const countReq = store.count();
                        
                        const count = await new Promise((resolve) => {
                            countReq.onsuccess = () => resolve(countReq.result);
                        });
                        
                        html += `<div style="color: #9ca3af;">${storeName}: <span style="color: #60a5fa;">${count} items</span></div>`;
                        
                        if (storeName.startsWith('messages_')) {
                            totalMessages += count;
                        }
                    } else {
                        html += `<div style="color: #6b7280;">${storeName}: <span style="color: #ef4444;">Not found</span></div>`;
                    }
                }
                
                html += `<div style="margin-top: 10px; color: #f3f4f6;">Total messages: <span style="color: #60a5fa; font-weight: bold;">${totalMessages}</span></div>`;
                
                // Check localStorage
                // Removed check for sww-filter-enabled - URL is now the single source of truth
                const filterEnabled = null; // Filter state is now only in the URL
                const filters = localStorage.getItem('sww-filters');
                const wordFilters = localStorage.getItem('sww-word-filters');
                const cachedComments = localStorage.getItem('sww-comments');
                
                html += '<h4 style="color: #34d399; margin-top: 15px;">localStorage:</h4>';
                
                // HIGHLIGHT THE CACHED COMMENTS!
                if (cachedComments) {
                    try {
                        const comments = JSON.parse(cachedComments);
                        html += `<div style="color: #ef4444; font-weight: bold;">‚ö†Ô∏è Cached Comments: <span style="color: #fbbf24;">${comments.length} messages</span> (THIS IS WHY YOU SEE MESSAGES!)</div>`;
                    } catch (e) {
                        html += `<div style="color: #ef4444;">Cached Comments: <span style="color: #fbbf24;">corrupted data</span></div>`;
                    }
                } else {
                    html += `<div style="color: #10b981;">‚úÖ No cached comments in localStorage</div>`;
                }
                
                html += `<div style="color: #9ca3af;">Filter Enabled: <span style="color: #60a5fa;">${filterEnabled || 'not set'}</span></div>`;
                html += `<div style="color: #9ca3af;">User Filters: <span style="color: #60a5fa;">${filters ? 'set' : 'empty'}</span></div>`;
                html += `<div style="color: #9ca3af;">Word Filters: <span style="color: #60a5fa;">${wordFilters ? 'set' : 'empty'}</span></div>`;
                
                statusDiv.innerHTML = html;
                db.close();
            } catch (error) {
                if (error.message !== 'Database not initialized') {
                    statusDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
                }
            }
        }
        
        // KV Viewer functionality
        async function checkKVStatus() {
            const viewer = document.getElementById('kv-viewer');
            const content = document.getElementById('kv-content');
            viewer.style.display = 'block';
            content.innerHTML = '<div style="color: #60a5fa;">‚è≥ Checking KV status...</div>';
            
            try {
                // Fetch recent comments from the API
                const response = await fetch('https://sww-comments.bootloaders.workers.dev/api/comments?limit=1');
                const data = await response.json();
                
                // Fetch stats
                const statsResponse = await fetch('https://sww-comments.bootloaders.workers.dev/api/stats');
                const stats = await statsResponse.json();
                
                let html = '<h4 style="color: #10b981; margin-top: 0;">üìä KV Storage Status</h4>';
                html += `<div style="color: #e5e7eb;">Total Messages: <span style="color: #fbbf24; font-weight: bold;">${stats.totalMessages || 0}</span></div>`;
                
                if (data.comments && data.comments.length > 0) {
                    const latest = data.comments[0];
                    html += `<div style="color: #e5e7eb; margin-top: 10px;">Latest Message (RAW):</div>`;
                    html += `<div style="background: #111827; padding: 10px; border-radius: 4px; margin-top: 5px;">`;
                    html += `<pre style="color: #10b981; font-size: 11px; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-all; margin: 0;">`;
                    html += JSON.stringify(latest, null, 2);
                    html += `</pre>`;
                    html += `</div>`;
                } else {
                    html += '<div style="color: #10b981; margin-top: 10px;">‚úÖ KV store is empty - ready for 9-digit colors!</div>';
                }
                
                content.innerHTML = html;
                showStatus('KV status checked');
            } catch (error) {
                content.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function copyAllKVData() {
            try {
                const response = await fetch('https://sww-comments.bootloaders.workers.dev/api/comments?limit=100');
                const data = await response.json();
                
                // Copy the raw JSON to clipboard
                const jsonStr = JSON.stringify(data, null, 2);
                navigator.clipboard.writeText(jsonStr).then(() => {
                    showStatus(`‚úÖ Copied ${data.comments?.length || 0} KV entries to clipboard (RAW JSON)`, 'success');
                }).catch(err => {
                    showStatus('‚ùå Failed to copy: ' + err, 'error');
                });
            } catch (error) {
                showStatus('‚ùå Failed to fetch KV data: ' + error.message, 'error');
            }
        }
        
        function copyKVEntry(entryId) {
            const element = document.getElementById(entryId);
            if (element) {
                const text = element.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    showStatus('‚úÖ Copied single KV entry to clipboard', 'success');
                }).catch(err => {
                    showStatus('‚ùå Failed to copy: ' + err, 'error');
                });
            }
        }
        
        async function viewRecentMessages() {
            const viewer = document.getElementById('kv-viewer');
            const content = document.getElementById('kv-content');
            viewer.style.display = 'block';
            content.innerHTML = '<div style="color: #60a5fa;">‚è≥ Loading recent messages...</div>';
            
            try {
                const response = await fetch('https://sww-comments.bootloaders.workers.dev/api/comments?limit=20');
                const data = await response.json();
                
                let html = '<h4 style="color: #10b981; margin-top: 0;">üìù RAW KV Entries (Last 20)</h4>';
                
                if (data.comments && data.comments.length > 0) {
                    // Analyze color formats
                    const formats = {
                        nineDigit: 0,
                        rgb: 0,
                        hex: 0,
                        none: 0,
                        other: 0
                    };
                    
                    data.comments.forEach(comment => {
                        const format = analyzeColorFormat(comment.color);
                        formats[format.type]++;
                    });
                    
                    // Show summary
                    html += '<div style="background: #111827; padding: 10px; border-radius: 4px; margin-bottom: 15px;">';
                    html += '<div style="color: #fbbf24; font-weight: bold; margin-bottom: 5px;">Color Format Summary:</div>';
                    if (formats.nineDigit > 0) html += `<div style="color: #10b981;">‚úÖ 9-digit: ${formats.nineDigit}</div>`;
                    if (formats.rgb > 0) html += `<div style="color: #f59e0b;">‚ö†Ô∏è RGB: ${formats.rgb}</div>`;
                    if (formats.hex > 0) html += `<div style="color: #60a5fa;">Hex: ${formats.hex}</div>`;
                    if (formats.none > 0) html += `<div style="color: #6b7280;">No color: ${formats.none}</div>`;
                    if (formats.other > 0) html += `<div style="color: #ef4444;">Other: ${formats.other}</div>`;
                    html += '</div>';
                    
                    // Show RAW KV entries
                    html += '<div style="max-height: 400px; overflow-y: auto;">';
                    data.comments.forEach((comment, index) => {
                        const entryId = `kv-entry-${index}`;
                        html += `<div style="background: #111827; padding: 8px; border-radius: 4px; margin-bottom: 8px;">`;
                        html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">`;
                        html += `<span style="color: #fbbf24; font-weight: bold;">Entry #${index + 1}:</span>`;
                        html += `<button onclick="copyKVEntry('${entryId}')" style="padding: 2px 8px; background: #374151; color: #60a5fa; border: 1px solid #4b5563; border-radius: 4px; cursor: pointer; font-size: 11px;">Copy</button>`;
                        html += `</div>`;
                        html += `<pre id="${entryId}" style="color: #10b981; font-size: 11px; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-all; margin: 0;">`;
                        html += JSON.stringify(comment, null, 2);
                        html += `</pre>`;
                        html += `</div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<div style="color: #10b981; margin-top: 10px;">‚úÖ No messages in KV store</div>';
                }
                
                content.innerHTML = html;
                showStatus(`Loaded ${data.comments?.length || 0} messages`);
            } catch (error) {
                content.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function analyzeColorFormat(color) {
            if (!color) {
                return {
                    format: 'No Color',
                    type: 'none',
                    icon: '‚ö™',
                    statusColor: '#6b7280',
                    displayColor: '#6b7280'
                };
            }
            
            if (/^\d{9}$/.test(color)) {
                return {
                    format: '9-Digit Format',
                    type: 'nineDigit',
                    icon: '‚úÖ',
                    statusColor: '#10b981',
                    displayColor: '#10b981'
                };
            }
            
            if (color.startsWith('rgb(')) {
                return {
                    format: 'RGB Format (Old)',
                    type: 'rgb',
                    icon: '‚ö†Ô∏è',
                    statusColor: '#f59e0b',
                    displayColor: '#f59e0b'
                };
            }
            
            if (color.startsWith('#')) {
                return {
                    format: 'Hex Format',
                    type: 'hex',
                    icon: 'üî∑',
                    statusColor: '#60a5fa',
                    displayColor: '#60a5fa'
                };
            }
            
            return {
                format: 'Unknown Format',
                type: 'other',
                icon: '‚ùì',
                statusColor: '#ef4444',
                displayColor: '#ef4444'
            };
        }
        
        function toggleAutoRefresh() {
            const btn = document.getElementById('auto-refresh-btn');
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.textContent = 'Enable Auto-Refresh';
                btn.style.background = '';
                showStatus('Auto-refresh disabled');
            } else {
                // Refresh every 5 seconds
                autoRefreshInterval = setInterval(() => {
                    viewRecentMessages();
                }, 5000);
                btn.textContent = 'Disable Auto-Refresh';
                btn.style.background = '#059669';
                showStatus('Auto-refresh enabled (5s interval)');
                viewRecentMessages(); // Load immediately
            }
        }
        
        // Show KV clear instructions
        function showKVClearInstructions() {
            const instructionsDiv = document.getElementById('kv-instructions');
            if (instructionsDiv.style.display === 'none') {
                instructionsDiv.style.display = 'block';
                showStatus('KV clear instructions displayed - follow the terminal commands');
            } else {
                instructionsDiv.style.display = 'none';
            }
        }
        
        // Copy KV clear command to clipboard
        function copyKVClearCommand() {
            const command = 'cd /Users/pbmacstudiomain/devrepo/SAYWHATWANTv1/saywhatwant && node scripts/kv-bulk-clear-final.js';
            navigator.clipboard.writeText(command).then(() => {
                showStatus('‚úÖ Fast bulk clear command copied! This will clear KV in seconds, not hours.');
            }).catch(err => {
                showStatus('‚ùå Failed to copy command: ' + err);
            });
        }
        
        async function clearAllStorage() {
            const statusDiv = document.getElementById('db-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div style="color: #60a5fa;">üóëÔ∏è Clearing all storage...</div>';
            
            try {
                // Clear localStorage completely
                localStorage.clear();
                
                // Clear sessionStorage
                sessionStorage.clear();
                
                // Clear IndexedDB
                await clearIndexedDB();
                
                statusDiv.innerHTML = '<div style="color: #10b981;">‚úÖ All storage cleared successfully!</div>';
                showStatus('All storage cleared!', 'success');
            } catch (error) {
                statusDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
                showStatus('Failed to clear storage', 'error');
            }
        }
    </script>
</body>
</html>
